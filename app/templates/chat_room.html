{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1 class="mt-4">Chat with {% if chat_room.user1_id == current_user.id %}{{ chat_room.user2.username }}{% else %}{{ chat_room.user1.username }}{% endif %}</h1>
    <div class="row">
        <div class="col-md-8">
            <div id="chat-messages" class="card" style="height: 400px; overflow-y: scroll;">
                <div class="card-body">
                    {% for message in messages %}
                    <div class="message mb-3">
                        <div class="font-weight-bold">{{ message.user.username }}</div>
                        <small class="text-muted">{{ message.timestamp }}</small>
                        <div>{{ message.content }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <form id="chat-form" class="mt-3">
                <div class="input-group">
                    <input type="text" id="message-input" class="form-control" placeholder="Type your message..." required>
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var chatMessages = document.getElementById('chat-messages');
        var chatForm = document.getElementById('chat-form');
        var messageInput = document.getElementById('message-input');

        var socket = io();

        socket.emit('join_room', {
            user_id: {{ current_user.id }},
            chat_room_id: {{ chat_room.id }}
        });

        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            var message = messageInput.value.trim();
            if (message !== '') {
                socket.emit('send_message', {
                    chat_room_id: {{ chat_room.id }},
                    user_id: {{ current_user.id }},
                    message: message
                });
                messageInput.value = '';
            }
        });

        socket.on('receive_message', function (data) {
            var messageElement = document.createElement('div');
            messageElement.classList.add('message', 'mb-3');
            messageElement.innerHTML = `
                <div class="font-weight-bold">${data.username}</div>
                <small class="text-muted">${data.timestamp}</small>
                <div>${data.content}</div>
            `;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        window.onbeforeunload = function () {
            socket.emit('leave_room', {
                user_id: {{ current_user.id }},
                chat_room_id: {{ chat_room.id }}
            });
        };
    });
</script>
{% endblock %}